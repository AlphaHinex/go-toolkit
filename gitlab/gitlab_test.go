package main

import (
	"fmt"
	"testing"
)

func TestParseDiff(t *testing.T) {
	diff := "@@ -33,7 +33,6 @@ import javax.validation.Valid;\n import java.io.BufferedReader;\r\n import java.io.IOException;\r\n import java.io.InputStreamReader;\r\n-import java.io.UnsupportedEncodingException;\r\n import java.util.Map;\r\n \r\n /**\r\n@@ -79,36 +78,11 @@ public class HssSiInterfaceController extends HsafController {\n     @PostMapping(\"/callService\")\r\n     @ApiOperation(value = \"国家局restful接收，发起方text/plain\")\r\n     public HsaInterfaceOutDTO2 callService(HttpServletRequest request, HttpServletResponse response) {\r\n-        HsaInterfaceOutDTO hsaOutDTO = new HsaInterfaceOutDTO();\r\n         HsaInterfaceInDTO hsaInDTO = new HsaInterfaceInDTO();\r\n-        hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE1);\r\n-        if(hsaOutDTO == null){\r\n-            return null;\r\n-        }\r\n-        HsaInterfaceOutDTO2 hsaOutDTO2 = new HsaInterfaceOutDTO2();\r\n-        BeanUtils.copyProperties(hsaOutDTO, hsaOutDTO2);\r\n-        if (HssStrUtil.equals(hsaOutDTO.getOutput(), \"[]\")) {\r\n-            hsaOutDTO2.setOutput(new JSONArray());\r\n-        } else if (HssStrUtil.equals(hsaOutDTO.getOutput(), \"{}\")) {\r\n-            hsaOutDTO2.setOutput(new JSONObject());\r\n-        } else {\r\n-            if (HssStrUtil.isNotBlank(hsaOutDTO.getOutput())&&hsaOutDTO.getOutput().startsWith(\"[\")) {\r\n-                hsaOutDTO2.setOutput(JSONArray.parseArray(hsaOutDTO.getOutput()));\r\n-            } else {\r\n-                try{\r\n-                    hsaOutDTO2.setOutput(JSONObject.parseObject(hsaOutDTO.getOutput()));\r\n-                }catch (Exception e){\r\n-                    hsaOutDTO2.setOutput(hsaOutDTO.getOutput());\r\n-                }\r\n-\r\n-            }\r\n-        }\r\n-        if (\"9102\".equals(hsaInDTO.getInfno()) && \"0\".equals(hsaOutDTO.getInfcode())) {\r\n-            return null;\r\n-        } else {\r\n-            return hsaOutDTO2;\r\n-        }\r\n+        HsaInterfaceOutDTO hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE1);\r\n+        return getHsaInterfaceOutDTO2(hsaInDTO, hsaOutDTO);\r\n     }\r\n+\r\n     /**\r\n      * 省平台移动支付入口\r\n      *\r\n@@ -119,10 +93,28 @@ public class HssSiInterfaceController extends HsafController {\n     @PostMapping(\"/provPayService\")\r\n     @ApiOperation(value = \"国家局restful接收，发起方text/plain\")\r\n     public HsaInterfaceOutDTO2 provPayService(HttpServletRequest request, HttpServletResponse response) {\r\n-        HsaInterfaceOutDTO hsaOutDTO = new HsaInterfaceOutDTO();\r\n         HsaInterfaceInDTO hsaInDTO = new HsaInterfaceInDTO();\r\n-        hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE4);\r\n-        if(hsaOutDTO == null){\r\n+        HsaInterfaceOutDTO hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE4);\r\n+        return getHsaInterfaceOutDTO2(hsaInDTO, hsaOutDTO);\r\n+    }\r\n+\r\n+    /**\r\n+     * 省处方中心入口\r\n+     *\r\n+     * @param request\r\n+     * @param response\r\n+     * @return\r\n+     */\r\n+    @PostMapping(\"/epcService\")\r\n+    @ApiOperation(value = \"国家局restful接收，发起方text/plain\")\r\n+    public HsaInterfaceOutDTO2 epcService(HttpServletRequest request, HttpServletResponse response) {\r\n+        HsaInterfaceInDTO hsaInDTO = new HsaInterfaceInDTO();\r\n+        HsaInterfaceOutDTO hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE6);\r\n+        return getHsaInterfaceOutDTO2(hsaInDTO, hsaOutDTO);\r\n+    }\r\n+\r\n+    private HsaInterfaceOutDTO2 getHsaInterfaceOutDTO2(HsaInterfaceInDTO hsaInDTO, HsaInterfaceOutDTO hsaOutDTO) {\r\n+        if (hsaOutDTO == null) {\r\n             return null;\r\n         }\r\n         HsaInterfaceOutDTO2 hsaOutDTO2 = new HsaInterfaceOutDTO2();\r\n@@ -132,12 +124,12 @@ public class HssSiInterfaceController extends HsafController {\n         } else if (HssStrUtil.equals(hsaOutDTO.getOutput(), \"{}\")) {\r\n             hsaOutDTO2.setOutput(new JSONObject());\r\n         } else {\r\n-            if (HssStrUtil.isNotBlank(hsaOutDTO.getOutput())&&hsaOutDTO.getOutput().startsWith(\"[\")) {\r\n+            if (HssStrUtil.isNotBlank(hsaOutDTO.getOutput()) && hsaOutDTO.getOutput().startsWith(\"[\")) {\r\n                 hsaOutDTO2.setOutput(JSONArray.parseArray(hsaOutDTO.getOutput()));\r\n             } else {\r\n-                try{\r\n+                try {\r\n                     hsaOutDTO2.setOutput(JSONObject.parseObject(hsaOutDTO.getOutput()));\r\n-                }catch (Exception e){\r\n+                } catch (Exception e) {\r\n                     hsaOutDTO2.setOutput(hsaOutDTO.getOutput());\r\n                 }\r\n \r\n@@ -149,6 +141,7 @@ public class HssSiInterfaceController extends HsafController {\n             return hsaOutDTO2;\r\n         }\r\n     }\r\n+\r\n     /**\r\n      * 调用本交易获取服务器时间以及秘钥信息\r\n      *\r\n@@ -161,15 +154,16 @@ public class HssSiInterfaceController extends HsafController {\n     public JSONObject getTimeStamp(HttpServletRequest request, HttpServletResponse response) {\r\n         JSONObject json = new JSONObject();\r\n         JSONObject jsonOUT = new JSONObject();\r\n-        json.put(\"DATE_TIME\",DateUtil.getCurrentDate(\"yyyyMMddHHmmss\"));\r\n-        json.put(\"KEY\",\"YB\".concat(DateUtil.getCurrentDate(\"yyyyMMdd\").substring(4)));\r\n+        json.put(\"DATE_TIME\", DateUtil.getCurrentDate(\"yyyyMMddHHmmss\"));\r\n+        json.put(\"KEY\", \"YB\".concat(DateUtil.getCurrentDate(\"yyyyMMdd\").substring(4)));\r\n         //System.out.println(\"****************拼接时间:\"+DateUtil.getCurrentDate(\"yyyyMMdd\").substring(4));\r\n-        log.info(\"****************拼接时间:\"+DateUtil.getCurrentDate(\"yyyyMMdd\").substring(4));\r\n-        jsonOUT.put(\"CODE\",\"200\");\r\n-        jsonOUT.put(\"MSG\",\"\");\r\n-        jsonOUT.put(\"DATA\",json);\r\n+        log.info(\"****************拼接时间:\" + DateUtil.getCurrentDate(\"yyyyMMdd\").substring(4));\r\n+        jsonOUT.put(\"CODE\", \"200\");\r\n+        jsonOUT.put(\"MSG\", \"\");\r\n+        jsonOUT.put(\"DATA\", json);\r\n         return jsonOUT;\r\n     }\r\n+\r\n     /**\r\n      * 社保卡内部认证\r\n      *\r\n@@ -190,17 +184,17 @@ public class HssSiInterfaceController extends HsafController {\n         BufferedReader streamReader;\r\n         String KNBRZURL = HssConfiguration.getConfig(\"ParaCodeA\", \"KNBRZURL\");\r\n         String KNBRZFLAG = HssConfiguration.getConfig(\"ParaCodeA\", \"KNBRZFLAG\");\r\n-        if(KNBRZFLAG == null ||\"\".equals(KNBRZFLAG)){\r\n+        if (KNBRZFLAG == null || \"\".equals(KNBRZFLAG)) {\r\n             KNBRZURL = \"http://10.80.6.105:8001/dwlesbserver/services/uddi?wsdl\"; //暂时默认为测试库\r\n             KNBRZFLAG = \"1\"; //默认需要卡内部认证\r\n         }\r\n-        if (\"0\".equals(KNBRZFLAG)){\r\n+        if (\"0\".equals(KNBRZFLAG)) {\r\n             // 0 不认证，1认证\r\n-            json.put(\"INTL_CRTF_DSCN_DATA\",\"\");//内部认证鉴别数据\r\n-            json.put(\"EXT_CRTF_DSCN_DATA\",\"\");//外部认证鉴别数据\r\n-            jsonOUT.put(\"CODE\",\"0\");\r\n-            jsonOUT.put(\"MSG\",\"\");\r\n-            jsonOUT.put(\"DATA\",json);\r\n+            json.put(\"INTL_CRTF_DSCN_DATA\", \"\");//内部认证鉴别数据\r\n+            json.put(\"EXT_CRTF_DSCN_DATA\", \"\");//外部认证鉴别数据\r\n+            jsonOUT.put(\"CODE\", \"0\");\r\n+            jsonOUT.put(\"MSG\", \"\");\r\n+            jsonOUT.put(\"DATA\", json);\r\n             return jsonOUT;\r\n         }\r\n \r\n@@ -220,9 +214,9 @@ public class HssSiInterfaceController extends HsafController {\n             String jydjgbh = \"37001300\"; // 默认为37001300\r\n             String str_akb020 = \"\";\r\n             //str_akb020 = \"660001\";  //暂时动态库没传过来，默认一个定点\r\n-            String sbm =\"\";\r\n+            String sbm = \"\";\r\n             String kfwxx = \"\";\r\n-            String sfbs =\"\";\r\n+            String sfbs = \"\";\r\n             String nbrzgcyz = \"\";\r\n             String nbrzysxx = \"\";\r\n             String wbrzgcyz = \"\";\r\n@@ -249,8 +243,7 @@ public class HssSiInterfaceController extends HsafController {\n             sbm = inputJson.getString(\"MDTRT_CERT_SN\"); //卡识别码\r\n \r\n \r\n-\r\n-            String xmlparm  = \"<?xml version=\\\"1.0\\\" encoding=\\\"GBK\\\"?>\" + \"<p>\"\r\n+            String xmlparm = \"<?xml version=\\\"1.0\\\" encoding=\\\"GBK\\\"?>\" + \"<p>\"\r\n                     + \"<s yybm = \\\"\"\r\n                     + str_akb020\r\n                     + \"\\\"/>\"\r\n@@ -283,22 +276,22 @@ public class HssSiInterfaceController extends HsafController {\n                     + \"\\\"/>\"\r\n                     + \"<s operationname = \\\"doSscardInternalCertification\\\"/>\"\r\n                     + \"</p>\";\r\n-            log.info(\"----卡内部认证调用省平台入参：\"+xmlparm);\r\n+            log.info(\"----卡内部认证调用省平台入参：\" + xmlparm);\r\n             Object[] objects = new Object[0];\r\n             // invoke(\"方法名\",参数1,参数2,参数3....);\r\n-            objects = client.invoke(method, \"Pp3Service\",\"doSscardInternalCertification\",xmlparm,\"http://serviceproxy.dareway.com\",\"invokeService\");\r\n+            objects = client.invoke(method, \"Pp3Service\", \"doSscardInternalCertification\", xmlparm, \"http://serviceproxy.dareway.com\", \"invokeService\");\r\n \r\n             //System.out.println(\"返回数据:\" + objects[0]);\r\n             log.info(\"返回数据:\" + objects[0]);\r\n-            String outXml = (String)objects[0];\r\n+            String outXml = (String) objects[0];\r\n             Map map = SDXmlUtil.SDXml2Map(outXml); //解析xml\r\n             String expcode = (String) map.get(\"expcode\"); //返回代码\r\n-            if(expcode!= null && \"0\".equals(expcode)){\r\n+            if (expcode != null && \"0\".equals(expcode)) {\r\n                 nbrzjbsj = (String) map.get(\"nbrzjbsj\"); //内部认证鉴别数据\r\n                 wbrzjbsj = (String) map.get(\"wbrzjbsj\"); //外部认证鉴别数据\r\n-            }else{\r\n+            } else {\r\n                 String exptext = (String) map.get(\"exptext\"); //返回错误信息\r\n-                throw new Exception(\"省平台返回，返回代码：\"+expcode+\",返回错误信息:\"+exptext);\r\n+                throw new Exception(\"省平台返回，返回代码：\" + expcode + \",返回错误信息:\" + exptext);\r\n             }\r\n \r\n             /*\r\n@@ -328,21 +321,22 @@ public class HssSiInterfaceController extends HsafController {\n             */\r\n         } catch (java.lang.Exception e) {\r\n             log.info(e.getMessage(), e);\r\n-            json.put(\"INTL_CRTF_DSCN_DATA\",\"\");//内部认证鉴别数据\r\n-            json.put(\"EXT_CRTF_DSCN_DATA\",\"\");//外部认证鉴别数据\r\n-            jsonOUT.put(\"CODE\",\"-1\");\r\n-            jsonOUT.put(\"MSG\",e.getMessage());\r\n-            jsonOUT.put(\"DATA\",json);\r\n+            json.put(\"INTL_CRTF_DSCN_DATA\", \"\");//内部认证鉴别数据\r\n+            json.put(\"EXT_CRTF_DSCN_DATA\", \"\");//外部认证鉴别数据\r\n+            jsonOUT.put(\"CODE\", \"-1\");\r\n+            jsonOUT.put(\"MSG\", e.getMessage());\r\n+            jsonOUT.put(\"DATA\", json);\r\n             return jsonOUT;\r\n         }\r\n \r\n-        json.put(\"INTL_CRTF_DSCN_DATA\",nbrzjbsj);//内部认证鉴别数据\r\n-        json.put(\"EXT_CRTF_DSCN_DATA\",wbrzjbsj);//外部认证鉴别数据\r\n-        jsonOUT.put(\"CODE\",\"0\");\r\n-        jsonOUT.put(\"MSG\",\"\");\r\n-        jsonOUT.put(\"DATA\",json);\r\n+        json.put(\"INTL_CRTF_DSCN_DATA\", nbrzjbsj);//内部认证鉴别数据\r\n+        json.put(\"EXT_CRTF_DSCN_DATA\", wbrzjbsj);//外部认证鉴别数据\r\n+        jsonOUT.put(\"CODE\", \"0\");\r\n+        jsonOUT.put(\"MSG\", \"\");\r\n+        jsonOUT.put(\"DATA\", json);\r\n         return jsonOUT;\r\n     }\r\n+\r\n     /**\r\n      * 社保卡鉴权\r\n      *\r\n@@ -363,17 +357,17 @@ public class HssSiInterfaceController extends HsafController {\n         BufferedReader streamReader;\r\n         String KJQURL = HssConfiguration.getConfig(\"ParaCodeA\", \"KJQURL\");\r\n         String KJQFLAG = HssConfiguration.getConfig(\"ParaCodeA\", \"KJQFLAG\");\r\n-        if(ObjectUtils.isEmpty(KJQFLAG)){\r\n+        if (ObjectUtils.isEmpty(KJQFLAG)) {\r\n             KJQURL = \"http://10.79.191.250:6666/kzx/services/CardServiceForProvince?wsdl\"; //暂时默认为原卡管地址\r\n             KJQFLAG = \"1\"; //默认需要卡鉴权\r\n         }\r\n-        if (\"0\".equals(KJQFLAG)){\r\n+        if (\"0\".equals(KJQFLAG)) {\r\n             // 0 不鉴权，1鉴权\r\n-            json.put(\"SUCC_FLAG\",\"1\");\r\n-            json.put(\"PRMMSG\",\"\");\r\n-            jsonOUT.put(\"CODE\",\"0\");\r\n-            jsonOUT.put(\"MSG\",\"\");\r\n-            jsonOUT.put(\"DATA\",json);\r\n+            json.put(\"SUCC_FLAG\", \"1\");\r\n+            json.put(\"PRMMSG\", \"\");\r\n+            jsonOUT.put(\"CODE\", \"0\");\r\n+            jsonOUT.put(\"MSG\", \"\");\r\n+            jsonOUT.put(\"DATA\", json);\r\n             return jsonOUT;\r\n         }\r\n         try {\r\n@@ -387,22 +381,22 @@ public class HssSiInterfaceController extends HsafController {\n             log.debug(\"卡鉴权入参:\" + sb.toString());\r\n             JSONObject jsonObject = JSON.parseObject(sb.toString());\r\n             String cardInfoStr = jsonObject.getString(\"CARD_INFO\");\r\n-            String[] cardInfo =  StrTool.split(cardInfoStr, HssConstants.COL_MID_SIGN);\r\n+            String[] cardInfo = StrTool.split(cardInfoStr, HssConstants.COL_MID_SIGN);\r\n             String urlAdress = KJQURL; // 正式环境\r\n             //urlAdress = \"http://10.79.191.250:6666/kzx/services/CardServiceForProvince?wsdl\";\r\n             String method = \"transBusinessForCard\";  // 方法名\r\n-            String transBusinessForCardResponse =  \"transBusinessForCardResponse\"; // xml返回中的标签\r\n-            String returnxml =  \"transBusinessForCardReturn\"; // xml返回中的标签\r\n+            String transBusinessForCardResponse = \"transBusinessForCardResponse\"; // xml返回中的标签\r\n+            String returnxml = \"transBusinessForCardReturn\"; // xml返回中的标签\r\n             //String  jybh = \"GGFW_GRWB_CX_010\"; // 测试使用\r\n             //String  inputs = \"<![CDATA[<?xml version=\\\"1.0\\\" encoding=\\\"GBK\\\"?><p><s name=\\\"市\\\" /><s areaCode=\\\"\\\" /><s hosLeval=\\\"\\\" /><s hosType=\\\"\\\" /></p>]]>\";\r\n             String insuplcAdmdvs = cardInfo[0];\r\n-            if (insuplcAdmdvs != null && !\"\".equals(insuplcAdmdvs) && !\"3713\".equals(insuplcAdmdvs)){\r\n+            if (insuplcAdmdvs != null && !\"\".equals(insuplcAdmdvs) && !\"3713\".equals(insuplcAdmdvs)) {\r\n                 // 不是本地卡，不进行卡鉴权,直接返回成功\r\n-                json.put(\"SUCC_FLAG\",\"1\");\r\n-                json.put(\"PRMMSG\",\"\");\r\n-                jsonOUT.put(\"CODE\",\"0\");\r\n-                jsonOUT.put(\"MSG\",\"\");\r\n-                jsonOUT.put(\"DATA\",json);\r\n+                json.put(\"SUCC_FLAG\", \"1\");\r\n+                json.put(\"PRMMSG\", \"\");\r\n+                jsonOUT.put(\"CODE\", \"0\");\r\n+                jsonOUT.put(\"MSG\", \"\");\r\n+                jsonOUT.put(\"DATA\", json);\r\n                 return jsonOUT;\r\n             }\r\n \r\n@@ -414,68 +408,69 @@ public class HssSiInterfaceController extends HsafController {\n             soapRequestParams.append(\"<soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:ser=\\\"http://service.webservice.catalog.infotrust.com\\\">\");\r\n             soapRequestParams.append(\"<soapenv:Header/>\");\r\n             soapRequestParams.append(\"<soapenv:Body>\");\r\n-            soapRequestParams.append(\"<ser:\"+method+\">\");  // 方法名开始标签\r\n-            soapRequestParams.append(\"<ser:in0>\"+keyInfo+\"</ser:in0>\");  // 参数1\r\n-            soapRequestParams.append(\"<ser:in1>\"+conInfo+\"</ser:in1>\");  // 参数2\r\n-            soapRequestParams.append(\"<ser:in2>\"+operType+\"</ser:in2>\"); // 参数3\r\n-            soapRequestParams.append(\"<ser:in3>\"+busType+\"</ser:in3>\");  // 参数4\r\n-            soapRequestParams.append(\"</ser:\"+method+\">\");// 方法名结束标签\r\n+            soapRequestParams.append(\"<ser:\" + method + \">\");  // 方法名开始标签\r\n+            soapRequestParams.append(\"<ser:in0>\" + keyInfo + \"</ser:in0>\");  // 参数1\r\n+            soapRequestParams.append(\"<ser:in1>\" + conInfo + \"</ser:in1>\");  // 参数2\r\n+            soapRequestParams.append(\"<ser:in2>\" + operType + \"</ser:in2>\"); // 参数3\r\n+            soapRequestParams.append(\"<ser:in3>\" + busType + \"</ser:in3>\");  // 参数4\r\n+            soapRequestParams.append(\"</ser:\" + method + \">\");// 方法名结束标签\r\n             soapRequestParams.append(\"</soapenv:Body>\");\r\n             soapRequestParams.append(\"</soapenv:Envelope>\");\r\n \r\n-            String xmlResult = WSHttpClientUils.doPostWebServiceURL(urlAdress,soapRequestParams.toString(),\"\");\r\n+            String xmlResult = WSHttpClientUils.doPostWebServiceURL(urlAdress, soapRequestParams.toString(), \"\");\r\n             //System.out.println(\"调用远程WebService接口返回\" +String.format(\"xml string:%s\" , xmlResult));\r\n-            log.info(\"调用远程WebService接口返回\" +String.format(\"xml string:%s\" , xmlResult));\r\n-            JSONObject wsjsonObject =  WSHttpClientUils.xml2Json(xmlResult); //将xml解析成json\r\n+            log.info(\"调用远程WebService接口返回\" + String.format(\"xml string:%s\", xmlResult));\r\n+            JSONObject wsjsonObject = WSHttpClientUils.xml2Json(xmlResult); //将xml解析成json\r\n             //System.out.println(\"调用远程接口返回json:\" +wsjsonObject.toJSONString());\r\n-            log.info(\"调用远程接口返回json:\" +wsjsonObject.toJSONString());\r\n+            log.info(\"调用远程接口返回json:\" + wsjsonObject.toJSONString());\r\n             JSONObject body = wsjsonObject.getJSONObject(\"Body\");\r\n             //System.out.println(\"调用远程接口返回json.body:\" +body.toJSONString());\r\n-            log.info(\"调用远程接口返回json.body:\" +body.toJSONString());\r\n+            log.info(\"调用远程接口返回json.body:\" + body.toJSONString());\r\n             JSONObject wbspUnifiedInterfaceResponse = body.getJSONObject(transBusinessForCardResponse);\r\n             //System.out.println(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse:\" +wbspUnifiedInterfaceResponse.toJSONString());\r\n-            log.info(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse:\" +wbspUnifiedInterfaceResponse.toJSONString());\r\n+            log.info(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse:\" + wbspUnifiedInterfaceResponse.toJSONString());\r\n             String strResult = wbspUnifiedInterfaceResponse.getString(returnxml);\r\n             //System.out.println(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse.returnxml:\" +strResult);\r\n-            log.info(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse.returnxml:\" +strResult);\r\n+            log.info(\"调用远程接口返回json.body.wbspUnifiedInterfaceResponse.returnxml:\" + strResult);\r\n             //V_result\t返回信息串\t格式：错误代码（0 成功 -1 失败）$ 错误信息 $g个人编号|社会保障号码|姓名|社保卡卡号|卡状态|金融账号|医保账号|银行类别|银行名称$\r\n             //System.out.println(\"返回社保卡信息strResult:\" + strResult);\r\n             log.info(\"返回社保卡信息strResult:\" + strResult);\r\n             //解析返回串\r\n             //0$$372827195001153730|372827195001153730|李学荣|Q21336899|1|6228231825095141265|6228231820508333443|95599|农业银行$\r\n-            if(ObjectUtils.isEmpty(strResult)){\r\n+            if (ObjectUtils.isEmpty(strResult)) {\r\n                 throw new Exception(\"人社卡管系统未返回信息.\");\r\n-            }else{\r\n-                String[]  strResultArray = StrTool.split(strResult,HssConstants.ROW_MID_SIGN);\r\n+            } else {\r\n+                String[] strResultArray = StrTool.split(strResult, HssConstants.ROW_MID_SIGN);\r\n                 String sucFlag = strResultArray[0];\r\n-                if(\"0\".equals(sucFlag)){\r\n-                    String[]  cardInfoArray = StrTool.split(strResultArray[2],HssConstants.COL_MID_SIGN);\r\n+                if (\"0\".equals(sucFlag)) {\r\n+                    String[] cardInfoArray = StrTool.split(strResultArray[2], HssConstants.COL_MID_SIGN);\r\n                     String cardStatus = cardInfoArray[4];\r\n-                    if(cardStatus == null || !\"1\".equals(cardStatus)){\r\n+                    if (cardStatus == null || !\"1\".equals(cardStatus)) {\r\n \r\n-                        throw new Exception(\"人社卡管系统返回卡状态不正常:\"+strResultArray[1]);\r\n+                        throw new Exception(\"人社卡管系统返回卡状态不正常:\" + strResultArray[1]);\r\n                     }\r\n-                }else{\r\n-                    throw new Exception(\"人社卡管系统返回错误信息:\"+strResultArray[1]);\r\n+                } else {\r\n+                    throw new Exception(\"人社卡管系统返回错误信息:\" + strResultArray[1]);\r\n                 }\r\n             }\r\n         } catch (Exception e) {\r\n             log.error(e.getMessage(), e);\r\n-            json.put(\"SUCC_FLAG\",\"-1\");\r\n-            json.put(\"PRMMSG\",e.getMessage());\r\n-            jsonOUT.put(\"CODE\",\"-1\");\r\n-            jsonOUT.put(\"MSG\",e.getMessage());\r\n-            jsonOUT.put(\"DATA\",json);\r\n+            json.put(\"SUCC_FLAG\", \"-1\");\r\n+            json.put(\"PRMMSG\", e.getMessage());\r\n+            jsonOUT.put(\"CODE\", \"-1\");\r\n+            jsonOUT.put(\"MSG\", e.getMessage());\r\n+            jsonOUT.put(\"DATA\", json);\r\n             return jsonOUT;\r\n         }\r\n \r\n-        json.put(\"SUCC_FLAG\",\"1\");\r\n-        json.put(\"PRMMSG\",\"\");\r\n-        jsonOUT.put(\"CODE\",\"0\");\r\n-        jsonOUT.put(\"MSG\",\"\");\r\n-        jsonOUT.put(\"DATA\",json);\r\n+        json.put(\"SUCC_FLAG\", \"1\");\r\n+        json.put(\"PRMMSG\", \"\");\r\n+        jsonOUT.put(\"CODE\", \"0\");\r\n+        jsonOUT.put(\"MSG\", \"\");\r\n+        jsonOUT.put(\"DATA\", json);\r\n         return jsonOUT;\r\n     }\r\n+\r\n     /**\r\n      * 外部支付入口。国家局标准接入，仿照此方法进行开门控制\r\n      *\r\n@@ -486,28 +481,9 @@ public class HssSiInterfaceController extends HsafController {\n     @PostMapping(\"/wsService\")\r\n     @ApiOperation(value = \"国家局restful接收，发起方text/plain\")\r\n     public HsaInterfaceOutDTO2 wsService(HttpServletRequest request, HttpServletResponse response) {\r\n-        HsaInterfaceOutDTO hsaOutDTO = new HsaInterfaceOutDTO();\r\n         HsaInterfaceInDTO hsaInDTO = new HsaInterfaceInDTO();\r\n-        hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response,HssConstants.REC_SYS_TYPE4);\r\n-\r\n-        HsaInterfaceOutDTO2 hsaOutDTO2 = new HsaInterfaceOutDTO2();\r\n-        BeanUtils.copyProperties(hsaOutDTO, hsaOutDTO2);\r\n-        if (HssStrUtil.equals(hsaOutDTO.getOutput(), \"[]\")) {\r\n-            hsaOutDTO2.setOutput(new JSONArray());\r\n-        } else if (HssStrUtil.equals(hsaOutDTO.getOutput(), \"{}\")) {\r\n-            hsaOutDTO2.setOutput(new JSONObject());\r\n-        } else {\r\n-            if (HssStrUtil.isNotBlank(hsaOutDTO.getOutput())&&hsaOutDTO.getOutput().startsWith(\"[\")) {\r\n-                hsaOutDTO2.setOutput(JSONArray.parseArray(hsaOutDTO.getOutput()));\r\n-            } else {\r\n-                hsaOutDTO2.setOutput(JSONObject.parseObject(hsaOutDTO.getOutput()));\r\n-            }\r\n-        }\r\n-        if (\"9102\".equals(hsaInDTO.getInfno()) && \"0\".equals(hsaOutDTO.getInfcode())) {\r\n-            return null;\r\n-        } else {\r\n-            return hsaOutDTO2;\r\n-        }\r\n+        HsaInterfaceOutDTO hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, HssConstants.REC_SYS_TYPE4);\r\n+        return getHsaInterfaceOutDTO2(hsaInDTO, hsaOutDTO);\r\n     }\r\n \r\n     /**\r\n@@ -541,7 +517,7 @@ public class HssSiInterfaceController extends HsafController {\n     public WrapperResponse<HsaInterfaceOutDTO2> callTest(HttpServletRequest request, HttpServletResponse response) {\r\n         HsaInterfaceOutDTO hsaOutDTO = new HsaInterfaceOutDTO();\r\n         HsaInterfaceInDTO hsaInDTO = new HsaInterfaceInDTO();\r\n-        hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response,\"test\");\r\n+        hsaOutDTO = siInterfaceService.callService(hsaInDTO, request, response, \"test\");\r\n \r\n         HsaInterfaceOutDTO2 hsaOutDTO2 = new HsaInterfaceOutDTO2();\r\n         BeanUtils.copyProperties(hsaOutDTO, hsaOutDTO2);\r\n"
	i, i2, i3, i4 := parseDiff(diff)
	if i != 114 {
		t.Error("add lines != 114")
	}
	if i2 != 138 {
		t.Error("del lines != 138")
	}
	if i3 != 22 {
		t.Error(fmt.Sprintf("add ignore space lines expect 22, but got %d", i3))
	}
	if i4 != 50 {
		t.Error(fmt.Sprintf("del ignore space lines expect 50, but got %d", i4))
	}
}

func TestParseProjectIds(t *testing.T) {
	fmt.Println(parseProjectIds("3,11-23,45-16,29"))
}
